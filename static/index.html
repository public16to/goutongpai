<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>沟通牌</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="app" v-cloak>
    <!-- 登录界面 -->
    <div class="full-screen login-wrapper" v-if="where === 0">
      <div class="login-panel  layout-center">
        <div class="row title">
          登录沟通牌服务器
        </div>
        <div class="login-form">
          <input type="text" class="input" placeholder="给自己取一个名字" v-model.trim="posState.p3.name" @keyup.enter="login"><button
            @click="login">确定</button>
        </div>
      </div>
    </div>


    <!-- 大厅 -->
    <div class="full-screen house" v-if="where === 1">
      <!-- <div class="row text-right quick-bar">
        <button @click="quickJoin">快速加入</button>
      </div> -->
      <div v-for="desk in desks" class="desk">
        <div v-for="position in desk.positions" class="position" :class="{has:position.state,position0:position.posId === 0,position1:position.posId === 1,position2:position.posId === 2,position3:position.posId === 3,position4:position.posId === 4,position5:position.posId === 5,position6:position.posId === 6,position7:position.posId === 7}">
          <span class="position-image" :class="{has:position.state===1,has2:position.state===2}" @click="sitDown(desk.deskId,position)"></span>
          <span class="position-text">{{position.userName}}</span>
        </div>
        <div class="position-center">{{desk.deskId}}</div>
      </div>
    </div>


    <!-- 房间 -->
    <div class="full-screen room" v-if="where === 2">
      <div class="btn-group" v-if="roomState.state > 0 && roomState.state < 3 && roomState.ctxPos === 'p3'">
        <span class="clock">{{roomState.timeout}}</span>
        <template v-if="roomState.state === 1">
          <button class="btn btn-call" v-for="score in roomState.ctxScore" @click="callScore(score)">{{score}}分</button>
          <button class="btn btn-call" @click="callScore(0)">不叫</button>
        </template>
        <template v-if="roomState.state === 2">
          <button class="btn" @click="playCards">出牌</button>
          <button class="btn" @click="passCards" v-if="roomState.ctxCard.ctxPos !== roomState.ctxPos">不出</button>
        </template>

      </div>

      <div class="btn-system">
        <button v-if="posState.p3.state < 3" @click="exitRoom" class="btn-exit-room">返回大厅</button>
        <button v-if="posState.p3.state < 2" @click="prepare" class="btn-prepare">准备</button>
      </div>


      <!-- 玩家头像 -->
      <div class="players">
        <div class="screen-center">
          <div class="player-wrapper player-p0" v-if="posState.p0.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p0.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p0.name}}</div>
            <div class="text-center player-status" v-if="posState.p0.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p1" v-if="posState.p1.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p1.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p1.name}}</div>
            <div class="text-center player-status" v-if="posState.p1.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p2" v-if="posState.p2.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p2.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p2.name}}</div>
            <div class="text-center player-status" v-if="posState.p2.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p4" v-if="posState.p4.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p4.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p4.name}}</div>
            <div class="text-center player-status" v-if="posState.p4.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p5" v-if="posState.p5.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p5.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p5.name}}</div>
            <div class="text-center player-status" v-if="posState.p5.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p6" v-if="posState.p6.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p6.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p6.name}}</div>
            <div class="text-center player-status" v-if="posState.p6.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>
          <div class="player-wrapper player-p7" v-if="posState.p7.state">
            <div class="player-photo" :class="{'player-photo-king':posState.p7.isDizhu}"></div>
            <div class="player-name text-center">{{posState.p7.name}}</div>
            <div class="text-center player-status" v-if="posState.p7.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          </div>

        </div>
        <!-- 自己的位置  -->
        <div class="player-wrapper player-p3" v-if="roomState.state === 0 || (roomState.state === 3 && posState.p3.state === 2)">
          <div class="player-photo" :class="{'player-photo-king':posState.p3.isDizhu}"></div>
          <div class="player-name text-center">{{posState.p3.name}}</div>
          <div class="text-center player-status" v-if="posState.p3.state === 2 && (roomState.state === 0 || roomState.state === 3)">已准备</div>
          <!-- <div class="text-center" v-if="posState.p3.isDizhu">
          <img src="images/dizhu.png" alt="">
        </div> -->
        </div>
      </div>

      <!-- <div class="msg-box">
        <div class="msg-list scroll-bar" ref="msgBox">
          <div class="msg-item" v-for="msg in msgList" :key="msg.id">
            <span v-if="msg.type === 'USER'">
              <span class="msg-item-time">[{{msg.time}}]</span>
              <span style="color:#fff">{{msg.name}}</span> 说：{{msg.content}}
            </span>
            <span style="color:#fff;padding:15px 0" v-if="msg.type === 'SYS'">
              <span class="msg-item-time">[{{msg.time}}] </span>系统消息：{{msg.content}}
            </span>
          </div>
        </div>
        <input type="text" class="input msg-input" ref="msgInput" @keyup.enter="sendMessage(false)">
        <select ref="msgSelect" class="input msg-input msg-select" style="width:15px;" @change="sendMessage($event)">
          <option v-for="item in msgBox" :value="item">{{item}}</option>
        </select>
        <button class="msg-btn" @click="sendMessage(false)">发送</button>
      </div>
    </div> -->

  </div>
  <script src="/js/vue.min.js"></script>
  <script src="socket.io/socket.io.js"></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/layer/layer.js"></script>
  <script src="/js/parser.js"></script>
  <script>

    function createClient(url) {
      var socket = io.connect('ws://' + url);
      return socket;
    }

    var vm = new Vue({
      el: "#app",
      data: function () {
        return {
          msgBox: [
            '你的牌打得太好了',
            '快点吧，我等到花儿也谢了！',
            '不要走，决战到天亮。',
            '要不起！',
            '炸炸炸炸炸炸。',
            '我有6个王！',
            '我有12个2！',
          ],
          msgList: [],//聊天消息

          where: 0,//0登录界面 1大厅 2房间,
          posId: '',//座位号
          deskId: '',//桌号
          desks: [],
          client: '',

          cards: [],

          //房间状态
          roomState: {
            state: 0,//0准备状态 1叫分状态 2打牌状态 3结束状态
            ctxPos: '', //当前该哪个座位谁出牌或叫分 //left right or self  p0 p1 p2 p3 p4 p5 p6 p7
            ctxCard: { //上家玩家的牌型
              len: 0,
              key: '',
              type: '',
              ctxPos: ''
            },
            ctxScore: [],
            timeout: 15,

          },
          //座位状态
          posState: {
            top: {
              cards: []
            },
            p0:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p1:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p2:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p3:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p4:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p5:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p6:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            p7:{
              state: 0,//0没人，1未准备 2准备
              cards: [],
              ctxCards: [],
              isPass: false,
              isDizhu: false,
              callScore: -1,
              name: '游客'
            },
            // left: {
            //   state: 0,//0没人，1未准备 2准备
            //   cards: [],
            //   ctxCards: [],
            //   isPass: false,
            //   isDizhu: false,
            //   callScore: -1,
            //   name: '游客'
            // },
            // right: {
            //   state: 0,//0没人，1未准备 2准备
            //   cards: [],
            //   ctxCards: [],
            //   isPass: false,
            //   isDizhu: false,
            //   callScore: -1,
            //   name: '游客'
            // },
            // self: {
            //   state: 0,//0没人，1未准备 2准备
            //   cards: [],
            //   ctxCards: [],
            //   isPass: false,
            //   isDizhu: false,
            //   callScore: -1,
            //   name: ''
            // }
          }
        }
      },
      mounted: function () {
        var self = this;
        this.$nextTick(function () {
          document.oncontextmenu = function (e) {
            e.preventDefault();
            self.playCards();
          };

          this.client = createClient(location.host);

          this.client.on('MESSAGE', function (data) {
            layer.msg(data.msg);
          }.bind(this));


          this.client.on('LOGIN_SUCCESS', function (data) {
            this.desks = data;
            this.where = 1;
            layer.closeAll();
          }.bind(this));

          this.client.on('LOGIN_FAIL', function (data) {
            layer.closeAll();
            layer.msg(data.msg);
          }.bind(this));



          this.client.on('SITDOWN_SUCCESS', function (data) {
            console.log(data);
            this.where = 2;
            this.posId = data.posId;
            this.deskId = data.deskId;
            data.posInfos.forEach(function (pos) {
              this.updatePosStatus(pos.posId, pos.state, pos.userName);
            }.bind(this))
            this.posState.p3.isDizhu = false;
            //this.msgList = [];
            this.$nextTick(function(){
                console.log(this.$refs.msgSelect);
                this.$refs.msgSelect.value = '';
            });
            layer.closeAll();
          }.bind(this));

          this.client.on('SITDOWN_ERROR', function (data) {
            layer.closeAll();
            layer.msg(data.msg);
          }.bind(this));


          this.client.on('UNSITDOWN_SUCCESS', function (data) {
            this.resetRoomStatus();
            this.desks = data;
            layer.closeAll();
          }.bind(this));

          this.client.on('REFRESH_LIST', function (data) {
            this.desks = data;
          }.bind(this));

          this.client.on('STATUS_CHANGE', function (data) {
            console.log(data);
            this.updateHouseStatus(data.deskId, data.posId, data.state,data.userName);
          }.bind(this));

          this.client.on('POS_STATUS_CHANGE', function (data) {
            var direct = this.getDirectionByPosId(data.posId);
            this.updatePosStatus(data.posId, data.state, data.userName);
          }.bind(this));

          this.client.on('POS_STATUS_RESET', function (data) {
            data.pos.forEach(function (pos) {
              this.updatePosStatus(pos.posId, data.state,data.userName);
            }.bind(this));
          }.bind(this));

          this.client.on('ROOM_STATUS_CHANGE', function (data) {
            this.roomState.state = data.state;
          }.bind(this));

          this.client.on('FORCE_EXIT_EV', function (data) {
            layer.msg(data.msg);

            this.roomState.state = 3;
            this.posState.p1.callScore = -1;
            this.posState.p2.callScore = -1;
            this.posState.p4.callScore = -1;
            this.posState.p5.callScore = -1;
            this.posState.p6.callScore = -1;
            this.posState.p7.callScore = -1;
            this.posState.p3.callScore = -1;

            var direct = this.getDirectionByPosId(data.posId);
            this.posState[direct].ctxCards = [];
            this.posState[direct].cards = [];
            this.startTimer(false);

          }.bind(this));

          this.client.on('PREPARE_SUCCESS', function (data) {
            this.posState.p3.state = 2;
            layer.closeAll();
          }.bind(this));

          //游戏开始
          this.client.on('GAME_START', function (data) {

            // 初始化数据
            this.roomState.state = 1;
            this.initCards(data.cards);
            this.posState.p1.callScore = -1;
            this.posState.p2.callScore = -1;
            this.posState.p4.callScore = -1;
            this.posState.p5.callScore = -1;
            this.posState.p6.callScore = -1;
            this.posState.p7.callScore = -1;
            this.posState.p3.callScore = -1;

            this.posState.p1.isPass = false;
            this.posState.p2.isPass = false;
            this.posState.p4.isPass = false;
            this.posState.p5.isPass = false;
            this.posState.p6.isPass = false;
            this.posState.p7.isPass = false;
            this.posState.p3.isPass = false;

            this.posState.p1.isDizhu = false;
            this.posState.p2.isDizhu = false;
            this.posState.p4.isDizhu = false;
            this.posState.p5.isDizhu = false;
            this.posState.p6.isDizhu = false;
            this.posState.p7.isDizhu = false;
            this.posState.p3.isDizhu = false;

            this.posState.p1.ctxCards = [];
            this.posState.p2.ctxCards = [];
            this.posState.p4.ctxCards = [];
            this.posState.p5.ctxCards = [];
            this.posState.p6.ctxCards = [];
            this.posState.p7.ctxCards = [];
            this.posState.p3.ctxCards = [];

          }.bind(this));


          //叫分事件
          this.client.on('CTX_USER_CHANGE', function (data) {
            this.updateCtxInfo(data);
          }.bind(this));

          //显示底牌事件
          this.client.on('SHOW_TOP_CARD', function (data) {
            this.roomState.state = 2;
            var direct = this.getDirectionByPosId(data.dizhuPosId);
            if (direct == 'p3') {
              data.topCards.forEach(function (card) {
                card.selected = true;
              })
            }
            this.posState[direct].cards = this.posState[direct].cards.concat(data.topCards).sort(function (a, b) {
              return a.value - b.value;
            });
            this.posState.top.cards = data.topCards;
            this.roomState.ctxPos = direct;
            this.posState[direct].isDizhu = true;
            this.roomState.timeout = data.timeout;
            this.startTimer(this.autoPlayCards.bind(this));
          }.bind(this));



          this.client.on('CTX_PLAY_CHANGE', function (data) {
            var direct = this.getDirectionByPosId(data.ctxData.posId);
            this.posState[direct].ctxCards = data.ctxData.cards;
            this.posState[direct].isPass = data.isPass;
            if (!data.isPass) {
              this.roomState.ctxCard.len = data.ctxData.len;
              this.roomState.ctxCard.key = data.ctxData.key;
              this.roomState.ctxCard.type = data.ctxData.type;
              this.roomState.ctxCard.ctxPos = direct;
            }
            this.removeCards(direct, data.ctxData.cards);
            this.roomState.ctxPos = this.getDirectionByPosId(data.posId);
            //如果是自己出牌就清空上一轮自己出的牌
            if (this.roomState.ctxPos === 'p3') {
              this.posState.p3.ctxCards = [];
            }
            this.posState[this.roomState.ctxPos].isPass = false;
            this.roomState.timeout = data.timeout;
            this.startTimer(this.autoPlayCards.bind(this));


          }.bind(this));

          this.client.on('PLAY_CARD_ERROR', function (data) {
            layer.msg('你的牌不符合规则');
          }.bind(this))
          this.client.on('PLAY_CARD_SUCCESS', function (cards) {
            this.removeCards('p3', cards);
            this.posState.p3.ctxCards = cards;
          }.bind(this))

          this.client.on('GAME_OVER', function (data) {
            var msg = data.winner.indexOf(this.posId) > - 1 ? '恭喜你，你赢了' : '很遗憾，你输了';
            var icon = data.winner.indexOf(this.posId) > - 1 ? 6 : 5;


            var content = '<div class="msg-title msg-' + (icon === 6 ? 'success' : 'fail') + '">' + msg + '</div><div>本局游戏统计如下：</div>';
            var score = data.score * data.ratio * 2;
            var halfScore = score / 2;
            data.winner.forEach(function (id) {
              var direct = this.getDirectionByPosId(id);
              content += '<div>' + this.posState[direct].name + '：+' + (score / data.winner.length) + '分</div>';
            }.bind(this));
            data.loser.forEach(function (id) {
              var direct = this.getDirectionByPosId(id);
              content += '<div>' + this.posState[direct].name + '：-' + (score / data.loser.length) + '分</div>';
            }.bind(this));


            layer.open({
              icon: icon,
              title: '本局结果',
              content: content
            });


            // layer.alert(msg, {
            //   icon: icon,
            // });
            this.startTimer(false);//停止计时器
            this.roomState.state = 3;

            this.posState.p0.state = 1;
            this.posState.p0.callScore = -1;
            this.posState.p0.isPass = false;

            this.posState.p1.state = 1;
            this.posState.p1.callScore = -1;
            this.posState.p1.isPass = false;

            this.posState.p2.state = 1;
            this.posState.p2.callScore = -1;
            this.posState.p2.isPass = false;

            this.posState.p4.state = 1;
            this.posState.p4.callScore = -1;
            this.posState.p4.isPass = false;

            this.posState.p5.state = 1;
            this.posState.p5.callScore = -1;
            this.posState.p5.isPass = false;

            this.posState.p6.state = 1;
            this.posState.p6.callScore = -1;
            this.posState.p6.isPass = false;

            this.posState.p7.state = 1;
            this.posState.p7.callScore = -1;
            this.posState.p7.isPass = false;

            this.posState.p3.state = 1;
            this.posState.p3.callScore = -1;
            this.posState.p3.isPass = false;

          }.bind(this));


          this.client.on('USER_MESSAGE', function (data) {
            var direct = this.getDirectionByPosId(data.posId);
            var name = this.posState[direct].name;
            this.msgList.push({
              type: data.type,
              id: data.id,
              time: data.time,
              name: name,
              content: data.msg
            })
            this.$nextTick(function () {
              this.$refs.msgBox.scrollTop = this.$refs.msgBox.scrollHeight;
            });
          }.bind(this));

        }.bind(this));
      },
      methods: {
        login: function () {
          if (!this.posState.p3.name) {
            return layer.msg('请输入名字');
          }
          if (this.posState.p3.name.length > 10) {
            return layer.msg('名字不超过10个字');
          }
          layer.load({ type: 3 });
          this.client.emit('LOGIN', this.posState.p3.name);
        },
        getDesk: function (deskId) {
          for (var i = 0, len = this.desks.length; i < len; i++) {
            var desk = this.desks[i];
            if (desk.deskId === deskId) {
              return desk;
            }
          }
          return null;
        },
        getPos: function (deskId, posId) {
          var desk = this.getDesk(deskId);
          if (desk) {
            for (var i = 0, len = desk.positions.length; i < len; i++) {
              var pos = desk.positions[i];
              if (pos.posId === posId) {
                return pos;
              }
            }
          }
          return null;
        },
        callScore: function (score) {
          this.posState.p3.callScore = score;
          this.roomState.ctxPos = '';
          this.client.emit('CALL_SCORE', { score: score });
        },
        updateCtxInfo: function (data) {
          var ctx = data;
          var direction = this.getDirectionByPosId(ctx.ctxPos);
          ctx.ctxPos = direction;
          this.roomState.ctxPos = ctx.ctxPos;
          this.roomState.ctxScore = ctx.ctxScore;
          this.roomState.timeout = ctx.timeout;
          if (ctx.calledScores) {
            for (var key in ctx.calledScores) {
              if (ctx.calledScores.hasOwnProperty(key)) {
                var posId = Number(key);
                var direct = this.getDirectionByPosId(posId);
                this.posState[direct].callScore = ctx.calledScores[key];
              }
            }
          }
          this.startTimer(function () {
            if (this.roomState.ctxPos == 'p3') {
              this.callScore(0);
            }
          });
        },
        startTimer: function () {
          var timer = null;
          return function (fn) {
            var self = this;
            if (timer) {
              clearInterval(timer);
              timer = null;
              if (!fn) {
                return;
              }
            }
            timer = setInterval(function () {
              self.roomState.timeout--;
              if (self.roomState.timeout <= 0) {
                clearInterval(timer);
                timer = null;
                self.roomState.timeout = 0;
                fn && fn.call(self);
              }
            }, 1000)

          }
        }(),
        updateHouseStatus: function (deskId, posId, state,userName) {
          var pos = this.getPos(deskId, posId);
          if (pos) {
            pos.state = state;
            pos.userName = userName;
          }
        },
        // 通过posId获取是哪个方向的坐位
        getDirectionByPosId: function (posId) {
          var mapping = {
            0: {
              0: 'p3',
              1: 'p4',
              2: 'p5',
              3: 'p6',
              4: 'p7',
              5: 'p0',
              6: 'p1',
              7: 'p2',
            },
            1: {
              0: 'p2',
              1: 'p3',
              2: 'p4',
              3: 'p5',
              4: 'p6',
              5: 'p7',
              6: 'p0',
              7: 'p1',
            },
            2: {
              0: 'p1',
              1: 'p2',
              2: 'p3',
              3: 'p4',
              4: 'p5',
              5: 'p6',
              6: 'p7',
              7: 'p0',
            },
            3: {
              0: 'p0',
              1: 'p1',
              2: 'p2',
              3: 'p3',
              4: 'p4',
              5: 'p5',
              6: 'p6',
              7: 'p7',
            },
            4: {
              0: 'p7',
              1: 'p0',
              2: 'p1',
              3: 'p2',
              4: 'p3',
              5: 'p4',
              6: 'p5',
              7: 'p6',
            },
            5: {
              0: 'p6',
              1: 'p7',
              2: 'p0',
              3: 'p1',
              4: 'p2',
              5: 'p3',
              6: 'p4',
              7: 'p5',
            },
            6: {
              0: 'p5',
              1: 'p6',
              2: 'p7',
              3: 'p0',
              4: 'p1',
              5: 'p2',
              6: 'p3',
              7: 'p4',
            },
            7: {
              0: 'p4',
              1: 'p5',
              2: 'p6',
              3: 'p7',
              4: 'p0',
              5: 'p1',
              6: 'p2',
              7: 'p3',
            }
          }
          return mapping[this.posId][posId];
        },
        updatePosStatus: function (posId, state, name) {
          var direct = this.getDirectionByPosId(posId);
          this.posState[direct].state = state;
          if (name) {
            this.posState[direct].name = name;
          }
          this.posState[direct].isDizhu = false;
          this.startTimer(false);

        },
        sitDown: function (deskId, pos) {
          if (pos.state === 0) {
            layer.load({ type: 3 });
            this.client.emit('SITDOWN', { deskId: deskId, posId: pos.posId });

          }
        },
        exitRoom: function () {
          this.client.emit('UNSITDOWN');
          layer.load({ type: 3 });
        },
        resetRoomStatus: function () {
          this.where = 1;
          this.posId = '';
          this.deskId = '';
          this.posState.p3.state = 0;
          this.roomState.state = 0;
          this.posState.p0.callScore = -1;
          this.posState.p1.callScore = -1;
          this.posState.p2.callScore = -1;
          this.posState.p4.callScore = -1;
          this.posState.p5.callScore = -1;
          this.posState.p6.callScore = -1;
          this.posState.p7.callScore = -1;
          this.posState.p3.callScore = -1;
        },
        getSelectdCards: function () {
          return this.posState.p3.cards.filter(function (card) {
            return card.selected;
          });
        },
        getCardIndex: function (pos, card) {
          var cards = this.posState[pos].cards;
          for (var i = 0, len = cards.length; i < len; i++) {
            var item = cards[i];
            if (card.value === item.value && card.type === item.type) {
              return i;
            }
          }
          return -1;
        },
        removeCards: function (pos, cards) {
          cards.forEach(function (card) {
            var index = this.getCardIndex(pos, card);
            if (index !== -1) {
              this.posState[pos].cards.splice(index, 1);
            }
          }.bind(this));
        },


        playCards: function (cards) {
          if (this.roomState.state !== 2) {
            return;
          }
          if (this.roomState.ctxPos !== 'p3') {
            return //layer.msg('未到出牌时间');
          }

          var cards = this.getSelectdCards();
          var ret = validate(cards);
          if (!ret.status) {
            return layer.msg('你的牌不符合规则');
          }

          this.client.emit('PLAY_CARD', cards);
        },
        //不出
        passCards: function () {
          this.client.emit('PLAY_CARD', [])
        },
        autoPlayCards: function () {
          if (this.roomState.ctxPos === 'p3') {
            var cards = this.roomState.ctxCard.ctxPos === 'p3' ? [this.posState.p3.cards[0]] : [];
            this.client.emit('PLAY_CARD', cards);
          }
        },
        prepare: function () {
          layer.load({ type: 3 });
          this.client.emit('PREPARE');
        },
        dragStart: function (e) {
          e.preventDefault();
        },
        selectCard: function (card) {
          card.selected = !card.selected;
        },
        initCards: function (cards) {
          cards.forEach(function (cardGroup, index) {
            cardGroup.cards.forEach(function (card) {
              card.selected = false;
            });
            var posId = cardGroup.id;
            var redirection = this.getDirectionByPosId(posId);
            this.posState[redirection].cards = cardGroup.cards;
          }.bind(this));
        },

        sendMessage: function (e) {
          var el = e ? e.target : this.$refs.msgInput;
          var msg = el.value;
          el.value = '';
          if (msg) {
            this.client.emit('USER_MESSAGE', msg);
          }
        },
        quickJoin: function () {
          layer.load({ type: 3 });
          this.client.emit('QUICK_JOIN');
        }
      }
    })

  </script>
</body>

</html>